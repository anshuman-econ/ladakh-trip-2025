<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ladakh Trip Dashboard</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
*{box-sizing:border-box}
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;margin:0;background:#0f1116;color:#e6e6e6}
header{position:sticky;top:0;background:#0f1116;border-bottom:1px solid #222;padding:10px 16px;display:flex;align-items:center;gap:16px;flex-wrap:wrap}
h1{margin:0;font-size:1.4rem}
.actions button{margin-right:8px}
.countdown{margin-left:auto;font-weight:600}
main{padding:16px;display:flex;flex-direction:column;gap:16px}
.panel{background:#151925;border:1px solid #21283b;border-radius:12px;padding:14px}
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
#map{height:360px;border-radius:8px;overflow:hidden;border:1px solid #223}
.legend{display:flex;align-items:center;gap:12px;margin-top:6px;font-size:.9rem;color:#c9d1d9}
.hint{opacity:.7}
#timeline{display:flex;gap:6px;flex-wrap:wrap}
.timeline-card{background:#171c2b;border:1px solid #24314a;border-radius:10px;padding:10px;min-width:180px}
.timeline-card .dates{opacity:.8;font-size:.9rem}
#flights{margin-top:8px}
.flight{padding:8px;border:1px solid #24314a;border-radius:8px;margin:6px 0}
#stays-table, #budget-table{width:100%;border-collapse:collapse}
#stays-table th, #stays-table td, #budget-table th, #budget-table td{border-bottom:1px solid #24314a;padding:8px;text-align:left}
.small-note{opacity:.7;font-size:.9rem;margin-top:6px}
footer{padding:12px 16px;color:#9aa4b2;font-size:.9rem;display:flex;justify-content:center}
button{background:#2b6cb0;color:white;border:none;padding:8px 10px;border-radius:8px;cursor:pointer}
button:hover{filter:brightness(1.05)}
input[type='checkbox']{vertical-align:middle}
.editable{cursor:text;background:#0f1116;border-bottom:1px dashed #3b4c6a}
@media (max-width: 900px){.grid-2{grid-template-columns:1fr}#map{height:300px}}

</style>
</head>
<body>
  <header>
    <h1 id="trip-title">Ladakh Trip</h1>
    <div class="countdown" id="countdown"></div>
    <nav class="actions">
      <button id="download-ics">Download .ics</button>
      <button id="export-json">Export JSON</button>
      <button id="reset-local">Reset edits</button>
    </nav>
  </header>

  <main>
    <section class="panel grid-2">
      <div>
        <h2>Map & Route</h2>
        <div id="map"></div>
        <div class="legend">
          <label><input type="checkbox" id="toggle-route" checked /> Show route line</label>
          <label><input type="checkbox" id="toggle-distance" checked /> Show distances</label>
          <button id="edit-pins">Edit pins</button>
          <span class="hint">Drag pins when edit mode is ON. Changes save to your browser.</span>
        </div>
      </div>
      <div>
        <h2>Day-by-day</h2>
        <div id="timeline"></div>
        <div id="flights"></div>
      </div>
    </section>

    <section class="panel grid-2">
      <div>
        <h2>Sleep Altitude</h2>
        <canvas id="altChart"></canvas>
        <div class="small-note">Altitudes are approximateâ€”edit in the Stay list.</div>
      </div>
      <div>
        <h2>Budget</h2>
        <table id="budget-table"></table>
        <div class="small-note">Click any cell to edit. Data saves to your browser.</div>
      </div>
    </section>

    <section class="panel">
      <h2>Stays</h2>
      <table id="stays-table"></table>
    </section>
  </main>

  <footer>
    <span>Made for your Ladakh adventure â€¢ Works offline as a PWA (Add to Home Screen)</span>
  </footer>

  <script>
// Ladakh Trip Dashboard logic
const state = {data:null, editPins:false, map:null, markers:[], line:null, showDistance:true};

async function loadData() {
  // prefer localStorage edits first
  const edited = localStorage.getItem("ladakh_trip_json");
  if (edited) {
    try { return JSON.parse(edited); } catch(e) { console.warn("Bad local JSON, falling back", e); }
  }
  return {"tripTitle": "Ladakh Trip (Aug 22\u201328, 2025)", "timezone": "Asia/Kolkata", "notes": "Dates and properties parsed from your emails. Edit directly in the page if anything looks off.", "flights": [{"when_local": "2025-08-23T09:30:00+05:30", "from": {"code": "DEL", "city": "New Delhi", "name": "Indira Gandhi Intl (T1)"}, "to": {"code": "IXL", "city": "Leh", "name": "Kushok Bakula Rimpoche"}, "airline": "IndiGo", "flight_no": "6E 2049", "arrive_local": "2025-08-23T10:50:00+05:30", "pnr": "Y21LUY"}, {"when_local": "2025-08-28T09:45:00+05:30", "from": {"code": "IXL", "city": "Leh", "name": "Kushok Bakula Rimpoche"}, "to": {"code": "DEL", "city": "New Delhi", "name": "Indira Gandhi Intl"}, "airline": "Air India", "flight_no": "AI 2453", "arrive_local": "2025-08-28T11:20:00+05:30", "pnr": "7UUWKO"}], "stays": [{"property": "Colonel's Retreat (Delhi)", "check_in": "2025-08-22", "check_out": "2025-08-23", "address": "New Delhi, India", "coords": {"lat": 28.567, "lng": 77.241}, "altitude_m": 216, "source": "GuestReservations email"}, {"property": "Shey Bhumi Resort", "check_in": "2025-08-23", "check_out": "2025-08-24", "address": "Chuchot Gongma, Leh, Ladakh 194101", "coords": {"lat": 34.04959, "lng": 77.64742}, "altitude_m": 3480, "source": "Goibibo voucher"}, {"property": "Ule Ethnic Resort", "check_in": "2025-08-24", "check_out": "2025-08-25", "address": "Uleytokpo, Khalsi, Ladakh 194101", "coords": null, "altitude_m": 3040, "source": "MakeMyTrip voucher"}, {"property": "Organic Village Retreat (Nubra)", "check_in": "2025-08-25", "check_out": "2025-08-26", "address": "Nubra Valley 194401, Ladakh", "coords": null, "altitude_m": 3100, "source": "Hotel email confirmation"}, {"property": "Misty Hills Cabins (Pangong, Spangmik)", "check_in": "2025-08-26", "check_out": "2025-08-27", "address": "Spangmik, Pangong Lake, Ladakh 194101", "coords": null, "altitude_m": 4250, "source": "MakeMyTrip voucher"}, {"property": "The Indus River Camp (Chuchot)", "check_in": "2025-08-27", "check_out": "2025-08-28", "address": "Chuchot Village Opposite Choglam Sar, Leh 194101", "coords": null, "altitude_m": 3340, "source": "Booking.com confirmation"}], "budget": {"currency": "INR", "items": [{"label": "Flights (DEL\u2194IXL)", "amount": null, "status": "paid"}, {"label": "Shey Bhumi Resort (1N)", "amount": null, "status": "paid"}, {"label": "Ule Ethnic (1N)", "amount": null, "status": "due"}, {"label": "Organic Village Retreat (1N)", "amount": null, "status": "due"}, {"label": "Misty Hills Cabins (1N)", "amount": null, "status": "nonrefundable"}, {"label": "Indus River Camp (1N)", "amount": null, "status": "prepaid"}, {"label": "Taxi/Driver (5 days)", "amount": null, "status": "estimate"}]}};
}

function fmtDate(d) {
  const dt = new Date(d);
  return dt.toLocaleDateString(undefined, {month:'short', day:'numeric'});
}

function nights(check_in, check_out) {
  const a = new Date(check_in);
  const b = new Date(check_out);
  return Math.round((b - a)/(1000*60*60*24));
}

function buildCountdown(firstDateStr) {
  const el = document.getElementById('countdown');
  const firstDate = new Date(firstDateStr);
  function tick() {
    const now = new Date();
    const diff = firstDate - now;
    if (diff <= 0) { el.textContent = "You're on the trip ðŸŽ‰"; return; }
    const days = Math.floor(diff / (1000*60*60*24));
    const hours = Math.floor((diff / (1000*60*60)) % 24);
    el.textContent = `T-${days}d ${hours}h`;
  }
  tick(); setInterval(tick, 60000);
}

function makeFlights(flights) {
  const wrap = document.getElementById('flights');
  wrap.innerHTML = '<h3>Flights</h3>';
  flights.forEach(f => {
    const div = document.createElement('div');
    div.className = 'flight';
    const dep = new Date(f.when_local);
    const arr = new Date(f.arrive_local);
    div.innerHTML = `
      <div><strong>${f.airline} ${f.flight_no}</strong> â€¢ PNR ${f.pnr||''}</div>
      <div>${f.from.code} â†’ ${f.to.code} â€¢ ${dep.toLocaleString()} â†’ ${arr.toLocaleTimeString()}</div>
    `;
    wrap.appendChild(div);
  });
}

function makeTimeline(stays) {
  const tl = document.getElementById('timeline');
  tl.innerHTML = '';
  stays.forEach(s => {
    const card = document.createElement('div');
    card.className = 'timeline-card';
    card.innerHTML = `
      <div><strong>${s.property}</strong></div>
      <div class="dates">${fmtDate(s.check_in)} â†’ ${fmtDate(s.check_out)} â€¢ ${nights(s.check_in, s.check_out)} night(s)</div>
      <div class="muted">${s.address||''}</div>
    `;
    tl.appendChild(card);
  });
}

function makeBudget(budget) {
  const tbl = document.getElementById('budget-table');
  tbl.innerHTML = '';
  const thead = document.createElement('thead');
  thead.innerHTML = `<tr><th>Item</th><th>Amount (${budget.currency})</th><th>Status</th></tr>`;
  tbl.appendChild(thead);
  const tb = document.createElement('tbody');
  budget.items.forEach((it, idx) => {
    const tr = document.createElement('tr');
    const amount = it.amount==null ? '' : it.amount;
    tr.innerHTML = `
      <td contenteditable="true" class="editable" data-section="budget" data-field="label" data-idx="${idx}">${it.label}</td>
      <td contenteditable="true" class="editable" data-section="budget" data-field="amount" data-idx="${idx}">${amount}</td>
      <td contenteditable="true" class="editable" data-section="budget" data-field="status" data-idx="${idx}">${it.status||''}</td>
    `;
    tb.appendChild(tr);
  });
  tbl.appendChild(tb);
}

function makeStaysTable(stays) {
  const tbl = document.getElementById('stays-table');
  tbl.innerHTML = '';
  const thead = document.createElement('thead');
  thead.innerHTML = '<tr><th>Property</th><th>Check-in</th><th>Check-out</th><th>Nights</th><th>Altitude (m)</th><th>Lat</th><th>Lng</th></tr>';
  tbl.appendChild(thead);
  const tb = document.createElement('tbody');
  stays.forEach((s, idx) => {
    const lat = s.coords?.lat ?? '';
    const lng = s.coords?.lng ?? '';
    const alt = s.altitude_m ?? '';
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td contenteditable="true" class="editable" data-section="stays" data-field="property" data-idx="${idx}">${s.property}</td>
      <td contenteditable="true" class="editable" data-section="stays" data-field="check_in" data-idx="${idx}">${s.check_in}</td>
      <td contenteditable="true" class="editable" data-section="stays" data-field="check_out" data-idx="${idx}">${s.check_out}</td>
      <td>${nights(s.check_in, s.check_out)}</td>
      <td contenteditable="true" class="editable" data-section="stays" data-field="altitude_m" data-idx="${idx}">${alt}</td>
      <td contenteditable="true" class="editable" data-section="stays" data-field="lat" data-idx="${idx}">${lat}</td>
      <td contenteditable="true" class="editable" data-section="stays" data-field="lng" data-idx="${idx}">${lng}</td>
    `;
    tb.appendChild(tr);
  });
  tbl.appendChild(tb);
}

function saveEdits(e) {
  if (!e.target.classList.contains('editable')) return;
  const el = e.target;
  const section = el.dataset.section;
  const field = el.dataset.field;
  const idx = Number(el.dataset.idx);
  const value = el.textContent.trim();
  if (section === 'budget') {
    state.data.budget.items[idx][field] = field==='amount' && value!=='' ? Number(value) : value;
  } else if (section === 'stays') {
    if (field === 'lat' || field === 'lng') {
      state.data.stays[idx].coords = state.data.stays[idx].coords || {};
      state.data.stays[idx].coords[field === 'lat' ? 'lat' : 'lng'] = value==='' ? null : Number(value);
    } else if (field === 'altitude_m') {
      state.data.stays[idx][field] = value==='' ? null : Number(value);
    } else {
      state.data.stays[idx][field] = value;
    }
    // re-render dependent views
    drawMap(state.data.stays);
    drawAltChart(state.data.stays);
    makeTimeline(state.data.stays);
  }
  localStorage.setItem('ladakh_trip_json', JSON.stringify(state.data));
}

async function geocodeIfNeeded(stay) {
  if (stay.coords && typeof stay.coords.lat === 'number' && typeof stay.coords.lng === 'number') return stay.coords;
  const q = encodeURIComponent(`${stay.property} ${stay.address || ''}`);
  const url = `https://nominatim.openstreetmap.org/search?q=${q}&format=json&limit=1`;
  try {
    const res = await fetch(url, {headers:{'Accept':'application/json'}});
    const js = await res.json();
    if (js && js.length>0) {
      const lat = Number(js[0].lat), lng = Number(js[0].lon);
      stay.coords = {lat, lng};
      return stay.coords;
    }
  } catch(e) {
    console.warn("Geocode failed for", stay.property, e);
  }
  return null;
}

function fitMap() {
  const group = new L.featureGroup(state.markers.map(m => m.marker));
  if (state.map && group.getLayers().length>0) state.map.fitBounds(group.getBounds().pad(0.25));
}

async function drawMap(stays) {
  if (!state.map) {
    state.map = L.map('map');
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 18, attribution: '&copy; OpenStreetMap'
    }).addTo(state.map);
  }
  // clear markers/line
  state.markers.forEach(m => m.marker.remove());
  state.markers = [];
  if (state.line) { state.line.remove(); state.line=null; }

  // ensure coords
  for (const s of stays) { await geocodeIfNeeded(s); }

  const coords = [];
  stays.forEach((s, idx) => {
    if (!s.coords) return;
    const marker = L.marker([s.coords.lat, s.coords.lng], {draggable: state.editPins});
    marker.addTo(state.map).bindPopup(`<strong>${s.property}</strong><br>${s.address||''}<br>${s.check_in} â†’ ${s.check_out}`);
    marker.on('dragend', (ev) => {
      const pos = ev.target.getLatLng();
      s.coords = {lat: pos.lat, lng: pos.lng};
      // update table cells
      const rows = document.querySelectorAll('#stays-table tbody tr');
      const row = rows[idx];
      row.children[5].textContent = pos.lat.toFixed(6);
      row.children[6].textContent = pos.lng.toFixed(6);
      localStorage.setItem('ladakh_trip_json', JSON.stringify(state.data));
      drawRouteLabel();
    });
    state.markers.push({marker, stay: s});
    coords.push([s.coords.lat, s.coords.lng]);
  });

  if (coords.length>1) {
    state.line = L.polyline(coords, {color:'#3fb950'}).addTo(state.map);
  }
  fitMap();
  drawRouteLabel();
}

function haversine(lat1, lon1, lat2, lon2) {
  const R = 6371; // km
  const toRad = (d) => d * Math.PI / 180;
  const dLat = toRad(lat2-lat1);
  const dLon = toRad(lon2-lon1);
  const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
  const c = 2*Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R*c;
}

function drawRouteLabel() {
  if (!state.showDistance) return;
  // Simple straight-line segment distances
  const labels = [];
  for (let i=0; i<state.markers.length-1; i++) {
    const a = state.markers[i].stay.coords;
    const b = state.markers[i+1].stay.coords;
    if (!a || !b) continue;
    const d = haversine(a.lat, a.lng, b.lat, b.lng);
    labels.push(`${state.markers[i].stay.property.split(' (')[0]} â†’ ${state.markers[i+1].stay.property.split(' (')[0]}: ${d.toFixed(1)} km`);
  }
  const legend = document.querySelector('.legend');
  let p = legend.querySelector('.distances');
  if (!p) { p = document.createElement('div'); p.className='distances'; legend.appendChild(p); }
  p.textContent = labels.join('  â€¢  ');
}

function drawAltChart(stays) {
  const ctx = document.getElementById('altChart');
  const labels = stays.map(s => s.property.split(' (')[0]);
  const data = stays.map(s => s.altitude_m || null);
  if (state.altChart) { state.altChart.destroy(); }
  state.altChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [{label:'Sleep altitude (m)', data}]
    },
    options: {
      responsive:true,
      plugins:{legend:{display:false}},
      scales:{y:{ticks:{callback:(v)=>v+' m'}}}
    }
  });
}

function generateICS(data) {
  const lines = ['BEGIN:VCALENDAR','VERSION:2.0','PRODID:-//Ladakh Trip//EN'];
  // Flights as events
  data.flights.forEach(f => {
    const dtStart = f.when_local.replace(/[-:]/g,'').replace(/\.\d{3}/,'').replace('+05:30','');
    const dtEnd = f.arrive_local.replace(/[-:]/g,'').replace(/\.\d{3}/,'').replace('+05:30','');
    lines.push('BEGIN:VEVENT');
    lines.push(`UID:${crypto.randomUUID()}@ladakh`);
    lines.push(`DTSTART:${dtStart}`);
    lines.push(`DTEND:${dtEnd}`);
    lines.push(`SUMMARY:${f.from.code}â†’${f.to.code} ${f.airline} ${f.flight_no}`);
    lines.push(`DESCRIPTION:PNR ${f.pnr||''}`);
    lines.push('END:VEVENT');
  });
  // Stays
  data.stays.forEach(s => {
    lines.push('BEGIN:VEVENT');
    lines.push(`UID:${crypto.randomUUID()}@ladakh`);
    lines.push(`DTSTART;VALUE=DATE:${s.check_in.replaceAll('-','')}`);
    lines.push(`DTEND;VALUE=DATE:${s.check_out.replaceAll('-','')}`);
    lines.push(`SUMMARY:Stay - ${s.property}`);
    lines.push(`LOCATION:${s.address||''}`);
    lines.push('END:VEVENT');
  });
  lines.push('END:VCALENDAR');
  return lines.join('\r\n');
}

function exportFile(name, content, mime) {
  const blob = new Blob([content], {type: mime});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = name;
  document.body.appendChild(a);
  a.click();
  a.remove();
}

function bindControls() {
  document.getElementById('export-json').addEventListener('click', () => {
    exportFile('trip.json', JSON.stringify(state.data, null, 2), 'application/json');
  });
  document.getElementById('download-ics').addEventListener('click', () => {
    exportFile('ladakh-trip.ics', generateICS(state.data), 'text/calendar');
  });
  document.getElementById('reset-local').addEventListener('click', () => {
    localStorage.removeItem('ladakh_trip_json');
    location.reload();
  });
  document.getElementById('toggle-route').addEventListener('change', (e) => {
    if (state.line) e.target.checked ? state.line.addTo(state.map) : state.line.remove();
  });
  document.getElementById('toggle-distance').addEventListener('change', (e) => {
    state.showDistance = e.target.checked;
    drawRouteLabel();
  });
  document.getElementById('edit-pins').addEventListener('click', () => {
    state.editPins = !state.editPins;
    document.getElementById('edit-pins').textContent = state.editPins ? 'Done' : 'Edit pins';
    drawMap(state.data.stays);
  });
  document.body.addEventListener('input', saveEdits);
}

async function init() {
  state.data = await loadData();
  document.getElementById('trip-title').textContent = state.data.tripTitle || 'Ladakh Trip';
  buildCountdown(state.data.stays[0].check_in + "T00:00:00");
  makeFlights(state.data.flights);
  makeTimeline(state.data.stays);
  makeBudget(state.data.budget);
  makeStaysTable(state.data.stays);
  await drawMap(state.data.stays);
  drawAltChart(state.data.stays);
  bindControls();
}
init();

</script>
</body>
</html>
